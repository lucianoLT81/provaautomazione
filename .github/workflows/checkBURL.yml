name: Controllo BUR Lazio
on:
  schedule:
    - cron: '0 * * * *' # Ogni ora
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Serve per salvare lo stato della pagina
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verifica BUR
        run: |
          # Scarica la pagina del BUR
          curl -s https://www.regione.lazio.it/bur -o bur_nuovo.html
          
          # Se non esiste un controllo precedente, lo crea e finisce qui
          if [ ! -f bur_vecchio.html ]; then
            mv bur_nuovo.html bur_vecchio.html
            git config user.name "GitHub Action"
            git config user.email "action@github.com"
            git add bur_vecchio.html
            git commit -m "Inizializzazione monitor BUR"
            git push
            echo "Primo avvio: archivio creato."
            exit 0
          fi

          # Confronta i file. Se sono DIVERSI, entra nell'if
          if ! cmp -s bur_nuovo.html bur_vecchio.html; then
            mv bur_nuovo.html bur_vecchio.html
            git config user.name "GitHub Action"
            git config user.email "action@github.com"
            git add bur_vecchio.html
            git commit -m "Nuovo BUR rilevato"
            git push
            echo "NUOVO DOCUMENTO TROVATO - STRONZO!"
            exit 1 # <--- QUESTO GENERA LA X ROSSA E L'EMAIL
          else
            echo "Nulla di nuovo."
            exit 0
          fi
