name: Controllo BUR Lazio
on:
  schedule:
    - cron: '0 * * * *' # Ogni ora
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Serve per salvare lo stato della pagina
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verifica BUR
        run: |
          # Scarica la pagina e rimuove i tag dinamici/casuali
          curl -s https://www.regione.lazio.it/bur | sed -E 's/(\?|&)(v|t|s|id)=[0-9a-zA-Z]*//g' > bur_nuovo.html
          
          if [ ! -f bur_vecchio.html ]; then
            mv bur_nuovo.html bur_vecchio.html
            git config user.name "GitHub Action"
            git config user.email "action@github.com"
            git add bur_vecchio.html
            git commit -m "Inizializzazione"
            git push
            exit 0
          fi

          # Confronta solo il testo (ignora differenze di spazi o metadati)
          if ! diff -q -w bur_nuovo.html bur_vecchio.html; then
            mv bur_nuovo.html bur_vecchio.html
            git config user.name "GitHub Action"
            git config user.email "action@github.com"
            git add bur_vecchio.html
            git commit -m "Nuovo BUR rilevato"
            git push
            echo "NUOVO DOCUMENTO TROVATO - STRONZO!"
            exit 1
          else
            echo "Nulla di nuovo."
            exit 0
          fi

#parole da cercare con la prossima versione: "CCI 2021IT05SFPR006"
